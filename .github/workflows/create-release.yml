name: Create Draft Release

on:
  pull_request:
    types: [closed]

jobs:
  create-draft-release:
    if: >
      github.event.pull_request.merged == true &&
      (contains(github.event.pull_request.labels.*.name, 'major') ||
       contains(github.event.pull_request.labels.*.name, 'minor') ||
       contains(github.event.pull_request.labels.*.name, 'patch'))
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Get latest *published* release version
      id: get_version
      env:
        GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      run: |
        set -e
        echo "Fetching latest published release tag..."

        # Get latest non-draft release (sorted by created_at descending)
        LATEST_PUBLISHED_TAG=$(gh release list --json tagName,isDraft,createdAt \
          --jq '[.[] | select(.isDraft == false)] | sort_by(.createdAt) | reverse | .[0].tagName' | tr -d '"' || echo "v0.0.0")

        echo "latest_published_tag=$LATEST_PUBLISHED_TAG" >> $GITHUB_OUTPUT

        VERSION=$(echo "$LATEST_PUBLISHED_TAG" | sed 's/^v//;s/[^0-9.].*$//')
        echo "current_version=$VERSION" >> $GITHUB_OUTPUT

        echo "âœ… Latest published tag: $LATEST_PUBLISHED_TAG"
        echo "âœ… Parsed current version: $VERSION"

    - name: Calculate new version
      id: calculate_version
      env:
        LABELS: ${{ join(github.event.pull_request.labels.*.name, ' ') }}
      run: |
        set -e
        CURRENT_VERSION="${{ steps.get_version.outputs.current_version }}"

        IFS='.' read -r MAJOR MINOR PATCH <<< "${CURRENT_VERSION:-0.0.0}"
        PATCH=${PATCH:-0}
        echo "Current version: $MAJOR.$MINOR.$PATCH"
        echo "Labels: $LABELS"

        if [[ "$LABELS" == *"major"* ]]; then
          NEW_MAJOR=$((MAJOR + 1)); NEW_MINOR=0; NEW_PATCH=0; VERSION_TYPE="major"
        elif [[ "$LABELS" == *"minor"* ]]; then
          NEW_MAJOR=$MAJOR; NEW_MINOR=$((MINOR + 1)); NEW_PATCH=0; VERSION_TYPE="minor"
        elif [[ "$LABELS" == *"patch"* ]]; then
          NEW_MAJOR=$MAJOR; NEW_MINOR=$MINOR; NEW_PATCH=$((PATCH + 1)); VERSION_TYPE="patch"
        else
          echo "No version label found."
          exit 1
        fi

        NEW_VERSION="${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"
        NEW_TAG="v${NEW_VERSION}"

        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
        echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT

        echo "Calculated new version: $NEW_TAG ($VERSION_TYPE)"

    - name: Get PR title for release notes
      id: get_pr_titles
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        RELEASE_NOTES="- $PR_TITLE"

        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        echo "âœ… Release notes generated."

    - name: Remove existing *auto-generated* draft releases
      env:
        GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      run: |
        set -e
        NEW_TAG="${{ steps.calculate_version.outputs.new_tag }}"
        echo "Checking for existing draft release with tag: $NEW_TAG"

        EXISTING_DRAFT=$(gh release list --json tagName,isDraft \
          --jq --arg tag "$NEW_TAG" '.[] | select(.tagName == $tag and .isDraft == true) | .tagName' | tr -d '"' || true)

        if [[ -n "$EXISTING_DRAFT" ]]; then
          BODY=$(gh release view "$NEW_TAG" --json body --jq '.body' || echo "")
          if echo "$BODY" | grep -q "Auto-generated draft release"; then
            echo "ðŸ§¹ Deleting existing auto-generated draft $NEW_TAG"
            gh release delete "$NEW_TAG" --yes
          else
            echo "Existing draft $NEW_TAG not auto-generated â€” keeping it."
          fi
        else
          echo "No existing draft found."
        fi

    - name: Ensure tag doesn't already exist
      run: |
        NEW_TAG="${{ steps.calculate_version.outputs.new_tag }}"
        if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
          echo "Tag $NEW_TAG already exists. Removing..."
          git push origin ":refs/tags/$NEW_TAG"
        fi

    - name: Create Draft Release
      run: |
        NEW_TAG="${{ steps.calculate_version.outputs.new_tag }}"
        VERSION_TYPE="${{ steps.calculate_version.outputs.version_type }}"
        LATEST_TAG="${{ steps.get_version.outputs.latest_published_tag }}"
        NOTES="${{ steps.get_pr_titles.outputs.release_notes }}"

        echo "Creating new draft release $NEW_TAG..."

        gh release create "$NEW_TAG" \
          --title "Release $NEW_TAG" \
          --notes "## ðŸš€ Auto-generated draft release

        **Version Type:** $VERSION_TYPE  
        **Previous Release:** $LATEST_TAG  
        **New Tag:** $NEW_TAG  

        ### ðŸ”§ Changes:
        $NOTES

        ---

        ### ðŸ§­ Next Steps
        1. **Publish this release** to trigger *Build and Push API Image*
        2. Wait for build to complete
        3. **Run 'Deploy to Environment'** with tag: \`$NEW_TAG\`

        _Auto-generated draft release by workflow_" \
          --draft

        echo "Draft release $NEW_TAG created successfully."
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

    outputs:
      new_tag: ${{ steps.calculate_version.outputs.new_tag }}
      version_type: ${{ steps.calculate_version.outputs.version_type }}
